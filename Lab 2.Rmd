---
title: "Laboratorio 2"
author: "Óscar Agüero Rodriguez"
date: "22/9/2020"
output: 
  github_document:
    toc: TRUE
    toc_depth: 2
---

# Laboratorio 2

## Paquetes a utilizar

```{r, message=FALSE}
library(starsdata)
library(tidyverse)
library(sf)
library(mapview)
library(stars)
library(RSQLite)
library(spacetime)
library(xts)
library(spDataLarge)
library(units)
library(cubelyr)
library(base)
library(nlme)
library(spatstat.data)
library(rpart)
library(spatstat)
library(raster)
library(plotrix)
library(maptools)
```

## Carga de dataset

Lectura de los datos a utilizar, son datos de la región de londres y su contenido son crimes entre Mayo y Junio del año 2014.

```{r}
setwd("~/Estadística/Spacial Stats")
data <- read.csv("london_street.csv", header = T, sep = ",")
data <- data[, 2:13]
str(data)
```
Limpieza de los datos, principalmente en eliminar los NA's del dataset.
 
```{r}
data <- data[!is.na(data$Longitude)&!is.na(data$Latitude),]
```

## Point Pattern Analysis

Primero se define las coordenadas de la base en función de la longitud y latitud del dataset.
Se necesita resolver el problema de los duplicados, ya que en el dataset se tiene dos crimenes en un mismo punto de referencia, por ejemplo. Esto es necesario resolverlo antes de realizar la proyección de los datos.

```{r}
coordinates(data)=~Longitude+Latitude
zero <- zerodist(data)
length(unique(zero[,1]))
```

Se descarga el archivo .shp

Nota: Se documenta la descarga y la extracción de los datos debido a que ya se ejecuto 1 vez, no es necesario repetir el proceso para efectos de este trabajo

```{r}
#download.file("http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/cultural/ne_10m_admin_1_states_provinces.zip",destfile="ne_10m_admin_1_states_provinces.zip")

#unzip("ne_10m_admin_1_states_provinces.zip",exdir="NaturalEarth")

border <- shapefile("NaturalEarth/ne_10m_admin_1_states_provinces.shp")

```

Se extrae solo el poligono de Londres para efectos del trabajo de crimes.

```{r}
GreaterLondon <- border[paste(border$region)=="Greater London",]
```

se busca trasponer los datos de crimes de Londres con el poligono de Londres, por lo que se requiere traslaparlos, eliminando primero aquellos puntos que no estan dentro del poligono de Londres. Para lo anterior se realiza la proyeccion de los datos con respecto a Londres, de traslapan y se eliminan los Na's

```{r}
projection(data)=projection(border)
overlay <- over(data,GreaterLondon)
data$over <- overlay$adm1_code
data.London <- data[!is.na(data$over),]
summary(data.London$Crime.type)
```

Se grafican los puntos proyectado para Londres sobre el poligono .shp, en este gráfico solo vamos a obtener los puntos que quedaron dentro del poligono, efecto de lo que se realizo en el chunk anterior.

```{r}
plot(data.London,pch="+",cex=0.5,main="",col=as.factor(data.London$Crime.type))
plot(GreaterLondon,add=T)
legend(x=-0.53,y=51.41,pch="+",col=unique(as.factor(data.London$Crime.type)),legend=unique(data.London$Crime.type),cex=0.4)
```

Calculo de estadísticas generales que utilizaran posterior

```{r}
mean_centerX <- mean(data.London@coords[,1])
mean_centerY <- mean(data.London@coords[,2])

standard_deviationX <- sd(data.London@coords[,1])
standard_deviationY <- sd(data.London@coords[,2])

standard_distance <- sqrt(sum(((data.London@coords[,1]-mean_centerX)^2+(data.London@coords[,2]-mean_centerY)^2))/(nrow(data.London)))
```

Estos calculos se realizan para ver la concentración (meramente visual) de los datos al rededor de la media o centro de un espacio geográfico, con esto se puede graficar de tal manera que se pueda sobreponer un circulo sobre el centro de los datos de toda la region de londres.

```{r}
plot(data.London,pch="+",cex=0.5,main="")
plot(GreaterLondon,add=T)
points(mean_centerX,mean_centerY,col="red",pch=16)
draw.circle(mean_centerX,mean_centerY,radius=standard_distance,border="red",lwd=2)
```
Se puede realizar de igual manera pero en lugar de un circulo, utilizar un elipse.

```{r}
plot(data.London,pch="+",cex=0.5,main="")
plot(GreaterLondon,add=T)
points(mean_centerX,mean_centerY,col="red",pch=16)
draw.ellipse(mean_centerX,mean_centerY,a=standard_deviationX,b=standard_deviationY,border="red",lwd=2)
```

## Working wwith spatstat 

Se seleccionan los datos de crimenes y se retiran los valores duplicados

```{r}
Drugs <- data.London[data.London$Crime.type==unique(data.London$Crime.type)[3],]
Drugs <- remove.duplicates(Drugs)
summary(Drugs)
```
Se realiza la transformación de los datos empleando spTransform para obtener un poligono espacial, en este caso la transformación se debe realizar para la variable Drugs y los crimenes de Londres.

```{r}
GreaterLondonUTM <- spTransform(GreaterLondon,CRS("+init=epsg:32630"))
Drugs.UTM <- spTransform(Drugs,CRS("+init=epsg:32630"))

```

Se transforma la variable GreaterLondonUTM a un objeto owin

```{r}
window <- as.owin(GreaterLondonUTM)
```

La función "ppp" permite crear un objeto que representa un patro en los datos de tal manera que se puedan poner en un plano de dos dimensiones.

```{r}
Drugs.ppp <- ppp(x=Drugs.UTM@coords[,1],y=Drugs.UTM@coords[,2],window=window)
GreaterLondonUTM <- spTransform(GreaterLondon,CRS("+init=epsg:32630"))
```

Se realiza una divición con el fin de tener 
 
```{r}
Drugs.ppp$n/sum(sapply(slot(GreaterLondonUTM, "polygons"), slot, "area"))
```


```{r}
plot(Drugs.ppp,pch="+",cex=0.5,main="Drugs")
plot(quadratcount(Drugs.ppp, nx = 4, ny = 4),add=T,col="blue")
```






